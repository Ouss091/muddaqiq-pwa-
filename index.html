<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ø§Ù„Ù…Ø¯Ù‚Ù‘Ù‚ â€” PWA</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#121212"/>
  <style>
    :root{--bg:#121212;--fg:#fff;--card:#1e1e1e;--accent:#3A86FF;--gold:#FFD166;}
    *{box-sizing:border-box;font-family:'Noto Naskh Arabic', system-ui, sans-serif}
    body{margin:0;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:linear-gradient(#121212dd,#12121200);backdrop-filter:saturate(120%) blur(2px);z-index:5}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #444;background:#0000;cursor:pointer}
    .chip.on{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 20%, transparent)}
    .chip.all.on{border-color:var(--gold);background:color-mix(in oklab, var(--gold) 25%, transparent)}
    textarea{width:100%;min-height:45vh;background:var(--card);color:var(--fg);border:1px solid #333;border-radius:16px;padding:16px;font-size:18px;line-height:1.7}
    .bar{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(#0000,#121212aa,#121212);}
    .row{display:flex;gap:10px}
    button{flex:1;padding:14px 16px;border-radius:14px;border:none;color:#fff;background:var(--accent);font-size:16px}
    button.tonal{background:#2a2a2a}
    button:disabled{opacity:.5}
    .settings{width:48px;flex:0 0 48px;border-radius:14px;background:#2a2a2a}
    .hint{opacity:.8;font-size:14px;margin:6px 2px}
    .badge{display:inline-block;padding:4px 8px;border-radius:12px;background:#2a2a2a;margin-right:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="chip" id="chip-lang">ØªØµØ­ÙŠØ­ Ø§Ù„Ù„ØºØ©</div>
        <div class="chip on" id="chip-spell">ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡</div>
        <div class="chip" id="chip-meaning">ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø¹Ù†Ù‰</div>
        <div class="chip all" id="chip-all">Ø§Ù„ÙƒÙ„ ğŸŒŸ</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <p class="hint">Ø§ÙƒØªØ¨ Ù†ØµÙƒ Ø«Ù… Ø§Ø¶ØºØ· Â«ØªØ¯Ù‚ÙŠÙ‚Â». Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø³Ù„ÙˆØ¨ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ.</p>
    <textarea id="text" placeholder="Ø§ÙƒØªØ¨ Ù†ØµÙƒ Ù‡Ù†Ø§... Ø«Ù… Ø§Ø¶ØºØ· ØªØ¯Ù‚ÙŠÙ‚ Ø£Ùˆ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø³Ù„ÙˆØ¨"></textarea>
    <div class="hint">
      Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge" id="status">ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ØªØµÙ„ (Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ù„ÙŠØ©)</span>
    </div>
    <div class="hint">Ø®Ø§Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ: <code id="apiBaseLabel"></code></div>
  </main>

  <div class="bar">
    <div class="wrap">
      <div class="row">
        <button id="btn-proof">ØªØ¯Ù‚ÙŠÙ‚</button>
        <button class="tonal" id="btn-style">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø³Ù„ÙˆØ¨</button>
        <button class="settings" id="btn-settings">âš™ï¸</button>
      </div>
    </div>
  </div>

  <dialog id="dlg">
    <form method="dialog" style="min-width: min(90vw, 520px); background:#1e1e1e;color:#fff;padding:18px;border-radius:16px">
      <h3 style="margin:8px 0">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
      <label>Ø±Ø§Ø¨Ø· Ø®Ø§Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <input id="apiBase" placeholder="Ù…Ø«Ø§Ù„: https://your-backend.example.com" style="width:100%;padding:10px;border-radius:10px;border:1px solid #444;background:#111;color:#fff;margin:8px 0"/>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button value="cancel" class="tonal" style="flex:0 0 auto">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="saveSettings" style="flex:0 0 auto;background:var(--gold);color:#000">Ø­ÙØ¸</button>
      </div>
    </form>
  </dialog>

  <script>
    // --- simple persistence ---
    const $ = sel => document.querySelector(sel);
    const chip = id => $(id);
    const state = {
      fixLang: JSON.parse(localStorage.getItem('fixLang') ?? 'false'),
      spell: JSON.parse(localStorage.getItem('spell') ?? 'true'),
      meaning: JSON.parse(localStorage.getItem('meaning') ?? 'false'),
      all: JSON.parse(localStorage.getItem('all') ?? 'false'),
      apiBase: localStorage.getItem('apiBase') ?? ''
    };

    function renderChips(){
      chip('#chip-lang').classList.toggle('on', state.fixLang);
      chip('#chip-spell').classList.toggle('on', state.spell);
      chip('#chip-meaning').classList.toggle('on', state.meaning);
      chip('#chip-all').classList.toggle('on', state.all);
      $('#apiBaseLabel').textContent = state.apiBase || 'â€”';
      $('#status').textContent = state.apiBase ? 'Ø³ÙŠØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ·' : 'ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ØªØµÙ„ (Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­Ù„ÙŠØ©)';
    }
    function saveChips(){
      localStorage.setItem('fixLang', JSON.stringify(state.fixLang));
      localStorage.setItem('spell', JSON.stringify(state.spell));
      localStorage.setItem('meaning', JSON.stringify(state.meaning));
      localStorage.setItem('all', JSON.stringify(state.all));
    }
    function toggleAll(v){
      state.all = v;
      state.fixLang = v; state.spell = v; state.meaning = v;
      saveChips(); renderChips();
    }
    chip('#chip-lang').onclick = ()=>{ state.fixLang = !state.fixLang; state.all=false; saveChips(); renderChips(); };
    chip('#chip-spell').onclick = ()=>{ state.spell = !state.spell; state.all=false; saveChips(); renderChips(); };
    chip('#chip-meaning').onclick = ()=>{ state.meaning = !state.meaning; state.all=false; saveChips(); renderChips(); };
    chip('#chip-all').onclick = ()=> toggleAll(!state.all);

    // --- simple local processors (fallback) ---
    const norm = t => t
      .replaceAll('?', 'ØŸ')
      .replaceAll(',', 'ØŒ')
      .replace(/Ù€+/g, '')
      .replace(/(ØŒ|Ø›|:|!|ØŸ)([^\s
])/g, (_,p1,p2)=> p1+' '+p2)
      .replace(/\s+(?=(ØŒ|Ø›|:|!|ØŸ))/g, '')
      .replace(/(\S)\s{2,}(\S)/g, '$1 $2');
    const lang = t => t
      .replace(/Ø¬Ø¯Ø§/g, 'Ø¬Ø¯Ù‹Ù‘Ø§')
      .replace(/(^|[\.!ØŸ]\s+)(ÙŠÙˆØ¬Ø¯\s)/g, (_,p1)=> p1+'Ù‡Ù†Ø§Ùƒ ');
    const meaning = t => t
      .replace(/Ø°Ù„Ùƒ\s+Ø§Ù„Ø£Ù…Ø±/g, 'Ø°Ù„Ùƒ')
      .replace(/([Ø€-Û¿]+)\s+/g, '$1');
    const style = t => t
      .replace(/\s+/g,' ').trim()
      .replace(/Ø­Ù‚Ø§/g,'Ø­Ù‚Ù‹Ù‘Ø§')
      .replace(/Ø¨Ø§Ù„Ø±ØºÙ…/g,'Ø¹Ù„Ù‰ Ø§Ù„Ø±ØºÙ…');

    async function callAPI(path, body){
      if(!state.apiBase) throw new Error('no-api');
      const res = await fetch(state.apiBase.replace(/\/$/,'') + path, {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error('bad-status');
      const data = await res.json();
      return data.improved ?? body.text;
    }

    $('#btn-proof').onclick = async () => {
      const ta = $('#text');
      let t = ta.value;
      const useAll = state.all;
      const doLang = state.fixLang || useAll;
      const doSpell = state.spell || useAll;
      const doMeaning = state.meaning || useAll;
      try{
        const improved = await callAPI('/proofread', {text:t, fix_language: doLang, check_spelling: doSpell, fix_meaning: doMeaning});
        ta.value = improved;
      }catch(e){
        // offline fallback
        if(doSpell) t = norm(t);
        if(doLang) t = lang(t);
        if(doMeaning) t = meaning(t);
        ta.value = t;
      }
    };

    $('#btn-style').onclick = async () => {
      const ta = $('#text');
      let t = ta.value;
      try{
        const improved = await callAPI('/style', {text:t});
        ta.value = improved;
      }catch(e){
        ta.value = style(t);
      }
    };

    // settings dialog
    const dlg = $('#dlg');
    $('#btn-settings').onclick = ()=>{
      $('#apiBase').value = state.apiBase;
      dlg.showModal();
    };
    $('#saveSettings').onclick = (ev)=>{
      ev.preventDefault();
      state.apiBase = $('#apiBase').value.trim();
      localStorage.setItem('apiBase', state.apiBase);
      renderChips();
      dlg.close();
    };

    // PWA
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
    renderChips();
  </script>
</body>
</html>
